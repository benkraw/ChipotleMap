<style>
body {
	background-color: white; 
	margin: 0 auto;
	width: 75%;
	font-family: Consolas, sans-serif;
	font-size: 1.5em;
	color: #454545;
	font-weight: bold;
	text-align: center;
}

svg {
	stroke-width: 1.8px;
	stroke: #CFCFCF;
	fill: #F0F0F0;
	margin-left: 5%;
}

circle {
	fill: #FF8533;
	stroke-width: 0px;
}

div.tooltip {
	color: white;
	background-color: black;
	padding: 0.5em;
	text-shadow: #F5F5F4 0 1px 0;
	border-radius: 7px;
	opacity: .9;
	font-size: 17px;
	position: absolute;
}

</style>
<body>
	<br><br>
	<center> Chipotle Restaurant Locations </center>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
	<script src="layoutMap.js"></script>
	<script src="data.js"></script>
		<script src="dataCDC.js"></script>


	<script>

var stateList = [];
for(var addr in coordinates){
		stateList.push(coordinates[addr].label.split(",")[1].split(" ")[1]);
}

var resultsStatesNum = _.reduce(stateList,function(counts,key){ counts[key]++; return counts },
                  _.object( _.map( _.uniq(stateList), function(key) { return [key, 0] })))

Object.prototype.getKey = function(value){
  for(var key in this){
    if(this[key] == value){
      return key;
    }
  }
  return null;
};

/* D3 MAGIC */
	var width = 960,
	height = 500;

	var projection = d3.geo.albersUsa()
	.scale(1000)
	.translate([width/2, height/2]);

	var tooltip = d3.select('body').append('div')
	.attr('class', 'hidden tooltip');
	tooltip[0][0].style.display = "None"

	var path = d3.geo.path().projection(projection);

	var d3_map = d3.select("body").append("svg:svg")
	.attr("width", width)
	.attr("height", height);

	var states = d3_map.append("svg:g")
	.attr("class", "states")
	.style("fill-opacity", "0.1")

	var locations = d3_map.append("svg:g")
	.attr("class", "locations");

	states.selectAll("path")
	.data(mapFeatures.features)
	.enter().append("path")
	.attr("d", path)
		.style("fill", function(d) {
			if(dataCDC[d.properties.name] != undefined){
				return "red";
			}
		})

	.on('mousemove', function(d) {
		var countLocs = resultsStatesNum[usStates.getKey(d.properties.name.toUpperCase())];
		if(countLocs === undefined){
			countLocs = 0;
		}
		var countEcoli = dataCDC[d.properties.name];
		if(countEcoli == undefined){
			countEcoli = 0;
		}
		tooltip[0][0].style.display = "block"
		var mouse = d3.mouse(locations.enter().append("svg:circle").node()).map(function(d) {
			return parseInt(d);
		});
		tooltip.classed('hidden', false)
		.attr('style', 'left:' + (mouse[0] + 15) +
			'px; top:' + (mouse[1]) + 'px')

		.html("<table><tr>" + d.properties.name + "</tr><br><hr><tr># of Resturants:" + countLocs
		 + "</tr><br><tr># of E.coli infections:" + countEcoli +"</tr></table>")
	})
	.on('mouseout', function() {
		tooltip[0][0].style.display = "none"
		tooltip.classed('hidden', true);
	});

	var locations = d3.select(".locations").selectAll('circle')
	.data(coordinates);

	locations.enter().append("svg:circle")
	.attr("cy", function(d) { return projection(d.coordinates)[1];})
	.attr("cx", function(d) { return projection(d.coordinates)[0];})
	.attr("id", function(d) { return d.label})
	.attr("r", 4.5)
	.attr('d', path)
	.on('mousemove', function(d) {
		tooltip[0][0].style.display = "block"
		var mouse = d3.mouse(locations.enter().append("svg:circle").node()).map(function(d) {
			return parseInt(d);
		});
		tooltip.classed('hidden', false)
		.attr('style', 'left:' + (mouse[0] + 15) +
			'px; top:' + (mouse[1]) + 'px')
		.html(d.label);
	})
	.on('mouseout', function() {
		tooltip[0][0].style.display = "none"
		tooltip.classed('hidden', true);
	});
	</script>


<script>
var table = $('<table/>').html('<thead><tr><th>States</th><th># E.coli infections</th></tr></thead>').appendTo('body'),    
tbody = table.append('<tbody/>');
console.log(table);
table[0].style.marginTop = "-47%";
table[0].style.marginLeft = "-15%";
$.each(dataCDC, function(key, value){
		if (key != "getKey"){
    tbody.append('<tr><td>'+key+'</td><td style="padding-left:20%;">'+value+'</td></tr>');
  }
});
</script>



</body>
</html>